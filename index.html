<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#165fb1"/>
<title>ANMAP_login</title>
<style>
  :root{--bg:#f4f7fb;--card:#fff;--accent:#165fb1;--muted:#6e7480;--border:#e6e9ef}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{width:100%;max-width:820px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(13,30,70,0.07)}
  h1{margin:0 0 4px;font-size:22px;font-weight:700;color:#0f3d7a}
  h2.subtitle{margin:0 0 12px;font-size:15px;font-weight:500;color:var(--muted)}
  label{font-size:13px;color:#333}
  input,select{width:100%;padding:12px;margin-top:6px;border-radius:9px;border:1px solid var(--border);font-size:15px;background:#fff}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  @media (max-width:720px){ .row.cols-2,.row.cols-3{grid-template-columns:1fr} }
  button{padding:12px 16px;border-radius:9px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .btn-outline{background:transparent;color:var(--accent);border:1px solid #dfe3f0}
  .section{margin-top:16px;padding-top:8px;border-top:1px dashed #e3e8f3}
  .note{margin-top:10px;color:var(--muted);font-size:13px}
  #secureArea{display:none;margin-top:14px}
  small.warn{display:block;margin-top:10px;color:#9a1c1c}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tg-link{display:inline-block;text-align:center;padding:12px 16px;border-radius:9px;border:1px solid #dfe6f3;background:transparent;color:#0f3d7a;text-decoration:none;font-weight:700}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .overlay .dialog{background:#fff;border-radius:12px;max-width:480px;width:100%;padding:20px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.2)}
  .countdown{font-size:22px;font-weight:700;color:#165fb1;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <h1>ANMAP_login</h1>
      <h2 class="subtitle">AgenÈ›ia NaÈ›ionalÄƒ de Mediu È™i Arii Protejate</h2>

      <!-- LOGIN -->
      <div id="loginBox">
        <div class="row cols-2">
          <div>
            <label for="user">Utilizator</label>
            <input id="user" placeholder="IntroduceÈ›i utilizatorul" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
          <div>
            <label for="pass">ParolÄƒ</label>
            <input id="pass" type="password" placeholder="IntroduceÈ›i parola" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
        </div>
        <div class="row section">
          <button id="btnLogin">Conectare</button>
          <small class="warn" id="warn" style="display:none"></small>
          <small class="note">Sesiunea se reseteazÄƒ automat cÃ¢nd pÄƒrÄƒseÈ™ti aplicaÈ›ia.</small>
        </div>
      </div>

      <!-- SECURE AREA -->
      <div id="secureArea" aria-hidden="true">
        <div class="topbar">
          <p class="note" style="margin:0">Formular intern â€” Proces-verbal de amplasament</p>
          <button id="btnLogout" class="btn-outline">Deconectare</button>
        </div>

        <form id="pvForm" class="section">
          <div class="row cols-3">
            <div><label>Nr. proces-verbal</label><input name="nr_pv" placeholder="ex: 123/2025"></div>
            <div><label>Data</label><input name="data" type="date"></div>
            <div><label>Ora</label><input name="ora" type="time"></div>
          </div>
          <div class="row cols-2">
            <div><label>JudeÈ›</label><input name="judet" placeholder="ex: BraÈ™ov"></div>
            <div><label>UAT / Localitate</label><input name="uat" placeholder="ex: Moieciu"></div>
          </div>
          <div class="footer-actions">
            <button type="button" id="btnPrint">ExportÄƒ PDF / Print</button>
            <button type="reset" class="btn-outline">ReseteazÄƒ</button>
          </div>
        </form>

        <div class="section tg-actions">
          <a class="tg-link" id="tgWeb" href="#">ANMAP_web</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay auto-close -->
  <div id="overlay" class="overlay">
    <div class="dialog">
      <h3>ðŸ”’ Telegram se va Ã®nchide automat</h3>
      <p>Tabul Telegram Web va fi Ã®nchis pentru siguranÈ›Äƒ Ã®n:</p>
      <div class="countdown"><span id="count">15</span> secunde</div>
      <small class="note">DupÄƒ Ã®nchidere, vei fi redirecÈ›ionat cÄƒtre login.</small>
    </div>
  </div>

<script>
const USERS={
  "george_g":"ab25424b76ddc669226641b8aa053cfe537df61d33f935fba3687c4924b9c84a",
  "anca_g":"ab25424b76ddc669226641b8aa053cfe537df61d33f935fba3687c4924b9c84a"
};

const $ = id => document.getElementById(id);
const user=$('user'), pass=$('pass'), btn=$('btnLogin'), warn=$('warn');
const login=$('loginBox'), secure=$('secureArea'), logout=$('btnLogout');
const printBtn=$('btnPrint'), tg=$('tgWeb'), overlay=$('overlay'), countEl=$('count');

async function sha256hex(s){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function resetLogin(){
  secure.style.display='none'; secure.setAttribute('aria-hidden','true');
  login.style.display='block'; user.value=''; pass.value='';
}
function forceFresh(){ const u=new URL(location.href); u.searchParams.set('r',Date.now()); location.replace(u); }

/* Login */
btn.addEventListener('click', async ()=>{
  warn.style.display='none';
  const u=user.value.trim(), p=pass.value;
  if(!u||!p){warn.textContent='CompleteazÄƒ utilizator È™i parolÄƒ.';warn.style.display='block';return;}
  if(!(u in USERS)){warn.textContent='Utilizator sau parolÄƒ incorecte.';warn.style.display='block';return;}
  const h=await sha256hex(p);
  if(h!==USERS[u]){warn.textContent='Utilizator sau parolÄƒ incorecte.';warn.style.display='block';return;}
  login.style.display='none'; secure.style.display='block'; secure.setAttribute('aria-hidden','false');
});
logout.addEventListener('click', forceFresh);
printBtn.addEventListener('click', ()=>window.print());

/* === Telegram auto-close === */
tg.addEventListener('click', e=>{
  e.preventDefault();
  overlay.style.display='flex';

  const tgWin = window.open('https://web.telegram.org/', '_blank', 'noopener,noreferrer,width=420,height=800');
  let secs=15;
  countEl.textContent=secs;

  const timer=setInterval(()=>{
    secs--; countEl.textContent=secs;
    if(secs<=0){
      clearInterval(timer);
      try{ if(tgWin && !tgWin.closed){ tgWin.close(); } }catch(e){}
      overlay.style.display='none';
      forceFresh();
    }
  },1000);

  // dacÄƒ utilizatorul Ã®nchide Telegram manual
  const check=setInterval(()=>{
    if(!tgWin || tgWin.closed){
      clearInterval(timer); clearInterval(check);
      overlay.style.display='none';
      forceFresh();
    }
  },2000);
});

/* Reset la revenire */
['visibilitychange','blur','pagehide','focus','pageshow'].forEach(evt=>{
  window.addEventListener(evt, ()=>{ if(document.visibilityState==='visible'||evt!=='visibilitychange'){ resetLogin(); }});
});

/* Register service worker (PWA) */
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{})); }

document.addEventListener('DOMContentLoaded', resetLogin);
</script>
</body>
</html>

