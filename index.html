<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#165fb1"/>
<title>ANMAP_login</title>
<style>
  :root{--bg:#f4f7fb;--card:#fff;--accent:#165fb1;--muted:#6e7480;--border:#e6e9ef}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{width:100%;max-width:820px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(13,30,70,0.07)}
  h1{margin:0 0 4px;font-size:22px;font-weight:700;color:#0f3d7a}
  h2.subtitle{margin:0 0 12px;font-size:15px;font-weight:500;color:var(--muted)}
  label{font-size:13px;color:#333}
  input,select,textarea{width:100%;padding:12px;margin-top:6px;border-radius:9px;border:1px solid var(--border);font-size:15px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  @media (max-width:720px){ .row.cols-2,.row.cols-3{grid-template-columns:1fr} }
  button{padding:12px 16px;border-radius:9px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .btn-outline{background:transparent;color:var(--accent);border:1px solid #dfe3f0}
  .section{margin-top:16px;padding-top:8px;border-top:1px dashed #e3e8f3}
  .note{margin-top:10px;color:var(--muted);font-size:13px}
  #secureArea{display:none;margin-top:14px}
  small.warn{display:block;margin-top:10px;color:#9a1c1c}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tg-link{display:inline-block;text-align:center;padding:12px 16px;border-radius:9px;border:1px solid #dfe6f3;background:transparent;color:#0f3d7a;text-decoration:none;font-weight:700}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .overlay .dialog{background:#fff;border-radius:12px;max-width:520px;width:100%;padding:20px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <h1>ANMAP_login</h1>
      <h2 class="subtitle">Agenția Națională de Mediu și Arii Protejate</h2>

      <!-- LOGIN -->
      <div id="loginBox">
        <div class="row cols-2">
          <div>
            <label for="user">Utilizator</label>
            <input id="user" placeholder="Introduceți utilizatorul" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
          <div>
            <label for="pass">Parolă</label>
            <input id="pass" type="password" placeholder="Introduceți parola" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
        </div>
        <div class="row section">
          <button id="btnLogin">Conectare</button>
          <small class="warn" id="warn" style="display:none"></small>
          <small class="note">Sesiunea nu se păstrează. La revenire vei fi pe login.</small>
        </div>
      </div>

      <!-- SECURE AREA -->
      <div id="secureArea" aria-hidden="true">
        <div class="topbar">
          <p class="note" style="margin:0">Formular intern — Proces-verbal de amplasament</p>
          <button id="btnLogout" class="btn-outline">Deconectare</button>
        </div>

        <form id="pvForm" class="section">
          <div class="row cols-3">
            <div><label>Nr. proces-verbal</label><input name="nr_pv" placeholder="ex: 123/2025"></div>
            <div><label>Data</label><input name="data" type="date"></div>
            <div><label>Ora</label><input name="ora" type="time"></div>
          </div>
          <div class="row cols-2">
            <div><label>Județ</label><input name="judet" placeholder="ex: Brașov"></div>
            <div><label>UAT / Localitate</label><input name="uat" placeholder="ex: Moieciu"></div>
          </div>
          <div class="row cols-2">
            <div><label>Adresă / Denumire amplasament</label><input name="adresa" placeholder="ex: Str. Principală nr. 1 / Pajiște alpină..."></div>
            <div>
              <label>Sistem de referință</label>
              <select name="srs">
                <option>WGS84 (EPSG:4326)</option>
                <option>Stereo 70 (EPSG:3844)</option>
                <option>ETRS89 / LAEA Europe (EPSG:3035)</option>
              </select>
            </div>
          </div>
          <div class="footer-actions">
            <button type="button" id="btnPrint">Exportă PDF / Print</button>
            <button type="reset" class="btn-outline">Resetează</button>
          </div>
        </form>

        <div class="section tg-actions">
          <a class="tg-link" id="tgWeb" href="#">ANMAP_web</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay info auto-close -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3 style="margin-top:0">Se deschide Telegram…</h3>
      <p>Din motive de securitate, tabul Telegram va fi închis automat în <b id="count">15</b> secunde (unde este posibil).<br/>
      Dacă nu se închide singur, te rugăm să îl închizi manual.</p>
      <button id="btnBackLogin" class="btn-outline" style="margin-top:10px">Revino la login</button>
    </div>
  </div>

<script>
/* === Config utilizatori === */
const USERS={
  "george_g":"ab25424b76ddc669226641b8aa053cfe537df61d33f935fba3687c4924b9c84a",
  "anca_g":"ab25424b76ddc669226641b8aa053cfe537df61d33f935fba3687c4924b9c84a"
};

/* === Elemente UI === */
const $ = id => document.getElementById(id);
const user=$('user'), pass=$('pass'), btn=$('btnLogin'), warn=$('warn');
const login=$('loginBox'), secure=$('secureArea'), logout=$('btnLogout'), printBtn=$('btnPrint');
const tg=$('tgWeb'), overlay=$('overlay'), countEl=$('count'), backBtn=$('btnBackLogin');

let tgWin=null, countdownTimer=null, closeTimer=null;

async function sha256hex(s){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function resetLogin(){
  secure.style.display='none';
  secure.setAttribute('aria-hidden','true');
  login.style.display='block';
  user.value=''; pass.value='';
  user.setAttribute('readonly',''); pass.setAttribute('readonly','');
}
function forceFresh(){
  const url=new URL(location.href);
  url.searchParams.set('r', Date.now().toString());
  location.replace(url.toString());
}

/* === Login logic === */
btn.addEventListener('click', async ()=>{
  warn.style.display='none';
  const u=(user.value||'').trim(), p=pass.value||'';
  if(!u||!p){warn.textContent='Completează utilizator și parolă.';warn.style.display='block';return;}
  if(!(u in USERS)){warn.textContent='Utilizator sau parolă incorecte.';warn.style.display='block';return;}
  const h=await sha256hex(p);
  if(h!==USERS[u]){warn.textContent='Utilizator sau parolă incorecte.';warn.style.display='block';return;}
  login.style.display='none';
  secure.style.display='block';
  secure.setAttribute('aria-hidden','false');
});
logout.addEventListener('click', forceFresh);
printBtn.addEventListener('click', ()=>window.print());

/* === Telegram: tab nou + auto-close (best-effort) === */
tg.addEventListener('click', e=>{
  e.preventDefault();
  // 1) deschide Telegram în tab nou
  tgWin = window.open('https://web.telegram.org/', '_blank', 'noopener,noreferrer');
  // 2) afișează overlay cu numărătoare
  overlay.style.display='flex';
  let secs=15; countEl.textContent=secs;
  countdownTimer = setInterval(()=>{
    secs--; countEl.textContent=secs;
    if(secs<=0){ clearInterval(countdownTimer); }
  },1000);
  // 3) încearcă să închidă fereastra după 15s (doar dacă platforma permite)
  closeTimer = setTimeout(()=>{
    try{
      if(tgWin && !tgWin.closed){ tgWin.close(); }
    }catch(e){}
    // revenim la login în app
    forceFresh();
  }, 15000);
});

/* Buton „Revino la login” din overlay */
backBtn.addEventListener('click', ()=>{ forceFresh(); });

/* === Reset la orice revenire în aplicație === */
['visibilitychange','blur','pagehide','beforeunload','focus','pageshow'].forEach(evt=>{
  window.addEventListener(evt, ()=>{
    // la revenire ne asigurăm de login curat
    if(evt==='visibilitychange' && document.visibilityState!=='visible') return;
    resetLogin();
  });
});

/* === PWA register === */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

/* Init */
document.addEventListener('DOMContentLoaded', resetLogin);
</script>
</body>
</html>
