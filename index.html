<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- Anti-cache pe client -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>ANMAP_login</title>
<style>
  :root{--bg:#f4f7fb;--card:#fff;--accent:#165fb1;--muted:#6e7480;--border:#e6e9ef}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{width:100%;max-width:820px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(13,30,70,0.07)}
  h1{margin:0 0 4px;font-size:22px;font-weight:700;color:#0f3d7a}
  h2.subtitle{margin:0 0 12px;font-size:15px;font-weight:500;color:var(--muted)}
  label{font-size:13px;color:#333}
  input, select, textarea{width:100%;padding:12px;margin-top:6px;border-radius:9px;border:1px solid var(--border);font-size:15px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  @media (max-width:720px){ .row.cols-2, .row.cols-3{grid-template-columns:1fr} }
  button{padding:12px 16px;border-radius:9px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .btn-outline{background:transparent;color:var(--accent);border:1px solid #dfe3f0}
  .section{margin-top:16px;padding-top:8px;border-top:1px dashed #e3e8f3}
  .note{margin-top:10px;color:var(--muted);font-size:13px}
  #secureArea{display:none;margin-top:14px}
  small.warn{display:block;margin-top:10px;color:#9a1c1c}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tg-link{display:inline-block;text-align:center;padding:12px 16px;border-radius:9px;border:1px solid #dfe6f3;background:transparent;color:#0f3d7a;text-decoration:none;font-weight:700}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  @media print{
    .wrap{padding:0}
    .card{box-shadow:none;border-radius:0}
    #loginBox, .topbar, .tg-actions{display:none!important}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">ANMAP_login</h1>
      <h2 class="subtitle">Agenția Națională de Mediu și Arii Protejate</h2>

      <!-- LOGIN -->
      <div id="loginBox">
        <form id="loginForm" autocomplete="off">
          <div class="row cols-2">
            <div>
              <label for="user">Utilizator</label>
              <input id="user" name="usr_x" placeholder="Introduceți utilizatorul"
                     autocomplete="off" autocapitalize="off" spellcheck="false"
                     readonly onfocus="this.removeAttribute('readonly');"/>
            </div>
            <div>
              <label for="pass">Parolă</label>
              <input id="pass" name="pwd_x" type="password" placeholder="Introduceți parola"
                     autocomplete="new-password" autocapitalize="off" spellcheck="false"
                     readonly onfocus="this.removeAttribute('readonly');"/>
            </div>
          </div>
          <div class="row section">
            <button id="btnLogin" type="button">Conectare</button>
            <small class="warn" id="warn" style="display:none"></small>
            <small class="note">Protecție locală (client-side). Pentru acces cu autentificare reală: Cloudflare Access sau backend propriu.</small>
          </div>
        </form>
      </div>

      <!-- ZONA SECURIZATĂ -->
      <div id="secureArea" aria-hidden="true">
        <div class="topbar">
          <p class="note" style="margin:0">Formular intern — Proces-verbal de amplasament</p>
          <button id="btnLogout" class="btn-outline" type="button">Deconectare</button>
        </div>

        <!-- FORMULAR PROCES-VERBAL AMPLASAMENT -->
        <form id="pvForm" class="section" autocomplete="off">
          <div class="row cols-3">
            <div><label>Nr. proces-verbal</label><input name="nr_pv" placeholder="ex: 123/2025"></div>
            <div><label>Data</label><input name="data" type="date"></div>
            <div><label>Ora</label><input name="ora" type="time"></div>
          </div>

          <div class="row cols-2">
            <div><label>Județ</label><input name="judet" placeholder="ex: Brașov"></div>
            <div><label>UAT / Localitate</label><input name="uat" placeholder="ex: Moieciu"></div>
          </div>

          <div class="row cols-2">
            <div><label>Adresă / Denumire amplasament</label><input name="adresa" placeholder="ex: Str. Principală nr. 1 / Pajiște alpină..."></div>
            <div>
              <label>Sistem de referință</label>
              <select name="srs">
                <option>WGS84 (EPSG:4326)</option>
                <option>Stereo 70 (EPSG:3844)</option>
                <option>ETRS89 / LAEA Europe (EPSG:3035)</option>
              </select>
            </div>
          </div>

          <div class="row cols-3">
            <div><label>Latitudine (φ)</label><input name="lat" placeholder="ex: 45.5"></div>
            <div><label>Longitudine (λ)</label><input name="lon" placeholder="ex: 25.35"></div>
            <div><label>Cota altitudinală (m)</label><input name="alt" placeholder="ex: 950"></div>
          </div>

          <div class="row cols-2">
            <div><label>Beneficiar / Titular</label><input name="beneficiar" placeholder="Nume persoană / societate"></div>
            <div><label>Reprezentant</label><input name="reprezentant" placeholder="Nume și calitate"></div>
          </div>

          <div class="row cols-2">
            <div><label>Agent constatator</label><input name="agent" placeholder="Nume și funcție"></div>
            <div><label>Însoțitori / Martori</label><input name="insotitori" placeholder="Nume / instituții"></div>
          </div>

          <div class="row"><label>Scop / Obiectiv vizită</label><textarea name="scop" placeholder="ex: verificare amplasament, evaluare impact, delimitare etc."></textarea></div>
          <div class="row"><label>Descriere amplasament</label><textarea name="descriere" placeholder="Caracteristici teren, acces, utilizare, vecinătăți, habitate, cursuri de apă, zone protejate etc."></textarea></div>
          <div class="row"><label>Observații</label><textarea name="observatii" placeholder="Aspecte suplimentare, neconformități, măsurători indicative"></textarea></div>

          <div class="row cols-2">
            <div><label>Măsuri dispuse</label><textarea name="masuri" placeholder="Măsuri/obligații, documente de depus, condiții"></textarea></div>
            <div><label>Termen</label><input name="termen" type="date"></div>
          </div>

          <div class="row cols-2">
            <div><label>Anexe</label><input name="anexe" placeholder="Planșe, poze, coordonate, schițe"></div>
            <div><label>Semnături (nume complet)</label><input name="semnaturi" placeholder="Agent / Reprezentant"></div>
          </div>

          <div class="footer-actions">
            <button type="button" id="btnPrint">Exportă ca PDF / Print</button>
            <button type="reset" class="btn-outline">Resetează formularul</button>
          </div>
        </form>

        <!-- ANMAP_web -->
        <div class="section tg-actions">
          <a class="tg-link" id="tgWeb" href="https://web.telegram.org/" target="_blank" rel="noopener">ANMAP_web</a>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======= CONFIG ======= */
const USERS={
  "george_g":"ab25424b76ddc669226641b8aa053cfe537df61d33f935fba3687c4924b9c84a",
  "anca_g":"ab25424b76ddc669226641b8aa053cfe537df61d33f935fba3687c4924b9c84a"
};

/* ======= LOGIC ======= */
const userInput=document.getElementById('user');
const passInput=document.getElementById('pass');
const btnLogin=document.getElementById('btnLogin');
const secureArea=document.getElementById('secureArea');
const loginBox=document.getElementById('loginBox');
const warn=document.getElementById('warn');
const btnLogout=document.getElementById('btnLogout');
const btnPrint=document.getElementById('btnPrint');

async function sha256hex(message){
  const msgUint8=new TextEncoder().encode(message);
  const hashBuffer=await crypto.subtle.digest('SHA-256',msgUint8);
  const hashArray=Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
}

function resetToLogin(){
  // ascunde zona securizată și curăță câmpurile
  secureArea.style.display='none';
  secureArea.setAttribute('aria-hidden','true');
  loginBox.style.display='block';
  userInput.value='';
  passInput.value='';
  // truc anti-autofill: repunem readonly până la focus
  userInput.setAttribute('readonly','');
  passInput.setAttribute('readonly','');
}

document.addEventListener('DOMContentLoaded', resetToLogin);

btnLogin.addEventListener('click',async()=>{
  warn.style.display='none';
  const u=(userInput.value||'').trim();
  const p=passInput.value||'';
  if(!u||!p){warn.textContent='Completează utilizator și parolă.';warn.style.display='block';return;}
  if(!(u in USERS)){warn.textContent='Utilizator sau parolă incorecte.';warn.style.display='block';return;}
  const h=await sha256hex(p);
  if(h!==USERS[u]){warn.textContent='Utilizator sau parolă incorecte.';warn.style.display='block';return;}
  loginBox.style.display='none';
  secureArea.style.display='block';
  secureArea.setAttribute('aria-hidden','false');
});

btnLogout.addEventListener('click', resetToLogin);
btnPrint.addEventListener('click',()=>{window.print();});

// Re-login forțat când: tab devine invizibil, pagina e lăsată în fundal, sau revii din bfcache
document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='hidden'){ try{ location.reload(); }catch(e){} }
});
window.addEventListener('pagehide',()=>{ try{ location.reload(); }catch(e){} });
window.addEventListener('pageshow',(e)=>{ if(e.persisted){ try{ location.reload(); }catch(_){} } });
window.addEventListener('beforeunload',()=>{ resetToLogin(); });

// expune utilitarul de hash (dacă vrei altă parolă, o generezi în consolă)
window._ANMAP={sha256hex};
</script>
</body>
</html>

